<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Directus Portal — Collections Browser</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter','ui-sans-serif','system-ui','Segoe UI','Roboto','Arial'] },
          colors: {
            ink:  '#0B0F17',
            pane: '#1a1333',
            pane2:'#221a44',
            card: '#2b215c',
            line: '#3b2c7a',
            text: '#F2F3F5',
            sub:  '#C9CADA',
            brand:'#8B7BFF',
            brand2:'#FF7BA5',
            good: '#22c55e',
            warn: '#f59e0b',
            bad:  '#ef4444'
          },
          boxShadow: {
            glass: '0 10px 40px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.04)'
          },
          borderRadius: {
            xl2: '1.25rem'
          }
        }
      }
    }
  </script>
  <style>
    .glass { background: linear-gradient(160deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); backdrop-filter: blur(10px) saturate(120%); }
    .elev { box-shadow: 0 20px 80px rgba(63, 48, 142, .35); }
    .btn:disabled { opacity:.5; cursor:not-allowed; }
  </style>
</head>
<body class="min-h-screen bg-ink text-text">

  <!-- Shell -->
  <div class="mx-auto max-w-7xl px-4 md:px-8 py-6 md:py-10 grid grid-cols-12 gap-6">

    <!-- Sidebar -->
    <aside class="col-span-12 md:col-span-2 rounded-xl2 glass shadow-glass border border-line/40 p-3 md:p-4">
      <div class="flex items-center gap-3 mb-4">
        <div class="w-10 h-10 rounded-2xl bg-brand/20 flex items-center justify-center">
          <svg viewBox="0 0 24 24" class="w-6 h-6 text-brand"><path d="M4 7a3 3 0 0 1 3-3h10a3 3 0 0 1 3 3v10a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3V7Z" fill="currentColor" opacity=".2"/><path d="M8 7h8v10H8z" stroke="currentColor" fill="none"/></svg>
        </div>
        <div>
          <div class="text-sm uppercase tracking-wider text-sub/80">Primary</div>
          <div class="font-semibold">Dashboard</div>
        </div>
      </div>

      <nav class="space-y-2">
        <button id="navCollections" class="w-full text-left px-3 py-2 rounded-xl bg-brand/10 hover:bg-brand/20 border border-line/30">
          Collections
        </button>
        <button id="navSession" class="w-full text-left px-3 py-2 rounded-xl bg-card/40 hover:bg-card/60 border border-line/30">
          Session
        </button>
      </nav>

      <div class="mt-6 text-xs text-sub/80 leading-relaxed">
        Logged in as <span id="miniMe" class="text-text/90">—</span>
      </div>
    </aside>

    <!-- Main -->
    <main class="col-span-12 md:col-span-7 space-y-6">

      <!-- Overview card -->
      <section class="rounded-xl2 glass elev border border-line/40 p-5 md:p-7">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div>
            <div class="text-sm text-sub/80">Overview</div>
            <h1 class="text-2xl md:text-3xl font-semibold">Data Browser</h1>
          </div>

          <!-- Session pill -->
          <div id="sessionPill" class="flex items-center gap-2 rounded-full border border-line/40 bg-card/40 px-3 py-1.5 text-sm">
            <span class="opacity-70">Session</span>
            <span id="sessionTime" class="font-semibold">—</span>
          </div>
        </div>

        <!-- Search + actions -->
        <div class="mt-5 grid grid-cols-1 md:grid-cols-3 gap-3">
          <input id="searchInput" placeholder="Search in table…" class="rounded-xl bg-card/40 border border-line/40 px-4 py-3 outline-none focus:ring-2 focus:ring-brand/60" />
          <select id="collectionSelect" class="rounded-xl bg-card/40 border border-line/40 px-4 py-3 outline-none focus:ring-2 focus:ring-brand/60">
            <option value="">Select a collection…</option>
          </select>
          <div class="flex gap-3">
            <button id="btnPrev" class="btn flex-1 rounded-xl bg-card/40 border border-line/40 hover:bg-card/60 px-4 py-3">Prev</button>
            <button id="btnNext" class="btn flex-1 rounded-xl bg-brand text-ink font-semibold hover:brightness-110 px-4 py-3">Next</button>
          </div>
        </div>

        <!-- Table -->
        <div class="mt-5 overflow-auto rounded-xl border border-line/40">
          <table class="min-w-full text-sm">
            <thead class="bg-card/60">
              <tr id="theadRow"></tr>
            </thead>
            <tbody id="tbodyRows" class="divide-y divide-line/30"></tbody>
          </table>
        </div>

        <div id="emptyState" class="hidden mt-6 text-center text-sub">Pick a collection to see its rows.</div>
      </section>

      <!-- Collections grid -->
      <section class="rounded-xl2 glass border border-line/40 p-5 md:p-7">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold">All Collections</h2>
          <button id="reloadCollections" class="rounded-xl bg-card/40 border border-line/40 px-3 py-2 hover:bg-card/60">Reload</button>
        </div>
        <div id="collectionsGrid" class="mt-5 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
      </section>
    </main>

    <!-- Right rail -->
    <aside class="col-span-12 md:col-span-3 space-y-6">

      <!-- Session / Auth card -->
      <section class="rounded-xl2 glass border border-line/40 p-5 md:p-6">
        <div class="flex items-center justify-between mb-3">
          <div>
            <div class="text-sm text-sub/80">Account</div>
            <div class="font-semibold">Session & Login</div>
          </div>
          <button id="logout" class="btn hidden rounded-xl px-4 py-2 bg-card/40 border border-line/40 hover:bg-card/60">
            Logout
          </button>
        </div>

        <div id="status" class="text-sm text-sub/80 mb-4">Initializing…</div>

        <form id="loginForm" class="space-y-3">
          <input id="email" type="email" placeholder="Email" autocomplete="username"
                 class="w-full rounded-xl bg-card/40 border border-line/40 px-4 py-3 focus:ring-2 focus:ring-brand/60" required />
          <input id="password" type="password" placeholder="Password" autocomplete="current-password"
                 class="w-full rounded-xl bg-card/40 border border-line/40 px-4 py-3 focus:ring-2 focus:ring-brand/60" required />
          <div class="flex gap-3">
            <button id="loginBtn" type="submit" class="btn flex-1 rounded-xl bg-brand text-ink font-semibold px-4 py-3 hover:brightness-110">Login</button>
            <button id="refreshBtn" type="button" class="btn flex-1 rounded-xl bg-card/40 border border-line/40 hover:bg-card/60 px-4 py-3">Refresh</button>
          </div>
        </form>
      </section>

      <!-- Info / Toast -->
      <section class="rounded-xl2 glass border border-line/40 p-5 md:p-6">
        <div class="text-sm text-sub/90">Tip: the purple pills and soft gradients echo your reference. Cards are glassy; corners are large; spacing is generous.</div>
      </section>

    </aside>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 hidden z-50">
    <div class="rounded-xl bg-card/80 border border-line/40 px-4 py-2 text-sm"> <span id="toastMsg"></span> </div>
  </div>

  <script>
    // ===== CONFIG =====
    const API = "https://test.mutahirmasood.com/api";    // your same-origin Directus mount
    const PAGE_SIZE = 25;

    // ===== UI utils =====
    const $ = (id) => document.getElementById(id);
    function toast(msg){ $("toastMsg").textContent=msg; $("toast").classList.remove("hidden"); setTimeout(()=>$("toast").classList.add("hidden"),1800); }

    // ===== Session timer =====
    let expiryAtMs = null, tickHandle = null;
    function setSessionExpiryMs(msOrNull){
      expiryAtMs = msOrNull;
      if(tickHandle) { clearInterval(tickHandle); tickHandle=null; }
      if(!msOrNull){ $("sessionTime").textContent = "—"; $("sessionPill").className="flex items-center gap-2 rounded-full border border-line/40 bg-card/40 px-3 py-1.5 text-sm"; return; }
      tickHandle = setInterval(updateCountdown, 1000); updateCountdown();
    }
    function updateCountdown(){
      const pill = $("sessionPill");
      const left = Math.max(0, Math.floor((expiryAtMs - Date.now())/1000));
      const mm = String(Math.floor(left/60)).padStart(2,"0");
      const ss = String(left%60).padStart(2,"0");
      $("sessionTime").textContent = `${mm}:${ss}`;
      pill.className="flex items-center gap-2 rounded-full border px-3 py-1.5 text-sm";
      if(left<=60) pill.classList.add("border-line/40","bg-bad/20"); else
      if(left<=300) pill.classList.add("border-line/40","bg-warn/20"); else
        pill.classList.add("border-line/40","bg-card/40");
    }
    async function syncExpiryFromServer(){
      // Ask for JSON (no cookie set) to read TTL in seconds
      const r = await fetch(`${API}/auth/refresh`, { method:"POST", credentials:"include" });
      if(!r.ok) return false;
      const body = await r.json();
      let ttl = body?.data?.expires;
      if(typeof ttl === "string") ttl = Number(ttl);
      if(typeof ttl !== "number") return false;
      // Ensure cookies align with the refreshed token timing
      await fetch(`${API}/auth/refresh`, { method:"POST", headers:{ "Content-Type":"application/json" }, credentials:"include", body: JSON.stringify({ mode:"session" }) });
      setSessionExpiryMs(Date.now() + ttl*1000);
      return true;
    }

    // ===== API helpers =====
    async function refreshSession(){
      const r = await fetch(`${API}/auth/refresh`, { method:"POST", headers:{ "Content-Type":"application/json" }, credentials:"include", body: JSON.stringify({ mode:"session" }) });
      return r.ok;
    }
    async function apiFetch(path, init={}, {retryOn401=true}={}){
      let res = await fetch(`${API}${path}`, { credentials:"include", ...init });
      if(res.status===401 && retryOn401){
        const ok = await refreshSession();
        if(ok){ await syncExpiryFromServer(); res = await fetch(`${API}${path}`, { credentials:"include", ...init }); }
      }
      return res;
    }

    // ===== State =====
    let currentCollection = "";
    let currentPage = 1;
    let currentRows = [];

    // ===== Rendering =====
    function renderTable(rows){
      const thead = $("theadRow");
      const tbody = $("tbodyRows");
      tbody.innerHTML = ""; thead.innerHTML = "";

      if(!rows || !rows.length){ $("emptyState").classList.remove("hidden"); return; }
      $("emptyState").classList.add("hidden");

      const cols = Array.from(new Set(rows.flatMap(r => Object.keys(r))));
      cols.slice(0, 10).forEach(k=>{
        const th = document.createElement("th");
        th.className="text-left font-semibold px-4 py-3";
        th.textContent = k;
        thead.appendChild(th);
      });

      rows.forEach(r=>{
        const tr = document.createElement("tr");
        cols.slice(0,10).forEach(k=>{
          const td = document.createElement("td");
          td.className="px-4 py-3 text-sub";
          const val = r[k];
          td.textContent = (val===null||val===undefined) ? "" : (typeof val === "object" ? JSON.stringify(val) : String(val));
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }
    function filterTable(term){
      if(!term) return renderTable(currentRows);
      const t = term.toLowerCase();
      const filtered = currentRows.filter(row => JSON.stringify(row).toLowerCase().includes(t));
      renderTable(filtered);
    }

    function renderCollectionsGrid(list){
      const grid = $("collectionsGrid"); grid.innerHTML="";
      list.forEach(c=>{
        const btn = document.createElement("button");
        btn.className = "w-full text-left rounded-xl2 bg-gradient-to-br from-card/80 to-pane/70 border border-line/40 hover:brightness-110 p-4 shadow-glass";
        btn.innerHTML = `
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-2xl bg-brand/20 flex items-center justify-center">
              <svg class="w-5 h-5 text-brand" viewBox="0 0 24 24" fill="currentColor"><path d="M4 6a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v3H4V6Zm0 5h16v7a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-7Z"/></svg>
            </div>
            <div>
              <div class="font-semibold">${c.collection}</div>
              <div class="text-xs text-sub/80">${c.schema?.comment || c.meta?.note || "—"}</div>
            </div>
          </div>`;
        btn.addEventListener("click", ()=>{ $("collectionSelect").value=c.collection; pickCollection(c.collection); });
        grid.appendChild(btn);
      });
    }

    // ===== Data actions =====
    async function loadCollections(){
      const res = await apiFetch(`/collections?limit=-1`);
      if(!res.ok) { toast("Failed to load collections"); return; }
      const { data } = await res.json();
      // Fill select
      const sel = $("collectionSelect"); sel.innerHTML = `<option value="">Select a collection…</option>`;
      data.forEach(c=>{
        const opt = document.createElement("option");
        opt.value=c.collection; opt.textContent=c.collection;
        sel.appendChild(opt);
      });
      renderCollectionsGrid(data);
    }

    async function pickCollection(name){
      currentCollection = name; currentPage=1;
      await loadPage();
    }

    async function loadPage(){
      if(!currentCollection){ $("emptyState").classList.remove("hidden"); renderTable([]); return; }
      const offset = (currentPage-1)*PAGE_SIZE;
      const res = await apiFetch(`/items/${encodeURIComponent(currentCollection)}?limit=${PAGE_SIZE}&offset=${offset}&meta=total_count`);
      if(!res.ok){ toast("Failed to load data"); return; }
      const body = await res.json();
      currentRows = body.data || [];
      renderTable(currentRows);
    }

    // ===== Event wiring =====
    $("reloadCollections").addEventListener("click", loadCollections);
    $("collectionSelect").addEventListener("change", (e)=> pickCollection(e.target.value));
    $("btnPrev").addEventListener("click", async ()=>{ if(currentPage>1){ currentPage--; await loadPage(); }});
    $("btnNext").addEventListener("click", async ()=>{ currentPage++; await loadPage(); });
    $("searchInput").addEventListener("input", (e)=> filterTable(e.target.value));

    // Sidebar nav (cosmetic)
    $("navCollections").addEventListener("click", ()=> window.scrollTo({ top: document.body.scrollHeight/3, behavior:"smooth"}));
    $("navSession").addEventListener("click", ()=> document.querySelector("aside ~ aside section").scrollIntoView({behavior:"smooth"}));

    // ===== Auth flow =====
    function setAuthedUI(isAuthed, email=""){
      $("miniMe").textContent = isAuthed ? email : "—";
      if(isAuthed){
        $("status").textContent = `Signed in${email ? " — "+email : ""}`;
        $("logout").classList.remove("hidden");
        $("loginForm").classList.add("hidden");
      } else {
        $("status").textContent = "Please log in.";
        $("logout").classList.add("hidden");
        $("loginForm").classList.remove("hidden");
        setSessionExpiryMs(null);
      }
    }

    $("loginForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      $("loginBtn").disabled=true;
      const email = $("email").value.trim();
      const password = $("password").value;
      const r = await fetch(`${API}/auth/login`, {
        method:"POST", headers:{ "Content-Type":"application/json" }, credentials:"include",
        body: JSON.stringify({ email, password, mode:"session" })
      });
      $("loginBtn").disabled=false;
      if(!r.ok){ toast("Login failed"); return; }
      const meR = await apiFetch("/users/me");
      if(meR.ok){ const me = await meR.json(); setAuthedUI(true, me?.data?.email||""); toast("Logged in"); await syncExpiryFromServer(); await loadCollections(); }
    });

    $("refreshBtn").addEventListener("click", async ()=>{
      const ok = await refreshSession();
      if(ok){ await syncExpiryFromServer(); const meR = await apiFetch("/users/me"); if(meR.ok){ const me = await meR.json(); setAuthedUI(true, me?.data?.email||""); } toast("Session refreshed"); }
      else toast("No active session");
    });

    $("logout").addEventListener("click", async ()=>{
      const r = await fetch(`${API}/auth/logout`, { method:"POST", headers:{ "Content-Type":"application/json" }, credentials:"include", body: JSON.stringify({mode:"session"}) });
      if(r.ok){ setAuthedUI(false); toast("Logged out"); }
    });

    // ===== Init =====
    (async ()=>{
      try{
        await refreshSession();                 // quietly renew if possible
        const meR = await apiFetch("/users/me", {}, {retryOn401:false});
        if(meR.ok){ const me = await meR.json(); setAuthedUI(true, me?.data?.email||""); await syncExpiryFromServer(); await loadCollections(); }
        else setAuthedUI(false);
      }catch(e){ setAuthedUI(false); }
    })();
  </script>
</body>
</html>
