<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Directus Portal Demo — Session Timer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['ui-sans-serif','system-ui','Inter','Segoe UI','Roboto','Arial'] },
          colors: {
            base: {
              bg: '#0B0F17',
              card: '#111827',
              line: '#1F2937',
              text: '#E5E7EB',
              sub: '#9CA3AF',
              brand: '#60A5FA',
              brand2: '#34D399',
              warn: '#FBBF24',
              danger: '#F87171'
            }
          },
          boxShadow: {
            soft: '0 6px 30px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.03)'
          }
        }
      }
    }
  </script>
  <style>
    .glass { background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); backdrop-filter: blur(10px) saturate(120%); }
    .btn:disabled { opacity:.5; cursor:not-allowed; }
    .tick { transition: color .2s ease, background-color .2s ease, border-color .2s ease; }
  </style>
</head>
<body class="min-h-screen bg-base-bg text-base-text">
  <div class="max-w-3xl mx-auto px-4 py-10">
    <!-- Header -->
    <header class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
      <h1 class="text-2xl md:text-3xl font-semibold tracking-tight">Directus Portal</h1>

      <!-- Session indicator -->
      <div class="flex items-center gap-3">
        <div id="sessionPill" class="tick rounded-full border px-3 py-1.5 text-sm border-base-line text-base-sub">
          <span class="opacity-70">Session:</span> <span id="sessionTime">—</span>
        </div>
        <button id="logout" class="btn hidden rounded-xl px-4 py-2 bg-base-line/50 hover:bg-base-line text-base-sub hover:text-base-text transition">
          Logout
        </button>
      </div>
    </header>

    <!-- Card -->
    <section class="mt-8 glass rounded-2xl shadow-soft border border-base-line">
      <div class="p-6 md:p-8">
        <!-- Status -->
        <div id="status" class="text-sm text-base-sub mb-4">Initializing…</div>

        <!-- Login Form -->
        <form id="loginForm" class="space-y-4">
          <div class="flex items-center gap-3 text-base-sub">
            <div class="w-10 h-10 rounded-xl bg-base-line/50 flex items-center justify-center">
              <!-- lock icon -->
              <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M7 10V8a5 5 0 1 1 10 0v2" stroke="currentColor" stroke-width="1.5"/>
                <rect x="4" y="10" width="16" height="10" rx="2" stroke="currentColor" stroke-width="1.5"/>
                <circle cx="12" cy="15" r="1.5" fill="currentColor"/>
              </svg>
            </div>
            <div>
              <h2 class="text-lg font-medium text-base-text">Sign in</h2>
              <p class="text-xs">Session cookie mode — secure, no tokens in localStorage.</p>
            </div>
          </div>

          <div class="grid md:grid-cols-2 gap-3">
            <input id="email" type="email" autocomplete="username" placeholder="Email"
                   class="w-full rounded-xl bg-base-card/60 border border-base-line px-4 py-3 focus:outline-none focus:ring-2 focus:ring-base-brand/60" required />
            <input id="password" type="password" autocomplete="current-password" placeholder="Password"
                   class="w-full rounded-xl bg-base-card/60 border border-base-line px-4 py-3 focus:outline-none focus:ring-2 focus:ring-base-brand/60" required />
          </div>

          <div class="flex items-center gap-3">
            <button id="loginBtn" type="submit"
                    class="btn rounded-xl bg-base-brand hover:bg-blue-400 text-black font-medium px-5 py-3 transition">
              Login
            </button>
            <button id="refreshBtn" type="button"
                    class="btn rounded-xl bg-base-line/60 hover:bg-base-line px-4 py-3 text-base-sub hover:text-base-text transition">
              Refresh Session
            </button>
            <span id="hint" class="text-xs text-base-sub hidden">Logged in — try loading data.</span>
          </div>
        </form>

        <!-- Actions (authed) -->
        <div id="actions" class="hidden mt-2">
          <div class="flex flex-wrap gap-3">
            <button id="whoami" class="btn rounded-xl bg-base-brand/20 hover:bg-base-brand/30 text-base-text px-4 py-2 transition">Who am I?</button>
            <button id="loadData" class="btn rounded-xl bg-base-brand2/20 hover:bg-base-brand2/30 text-base-text px-4 py-2 transition">Load “test” Collection</button>
            <button id="clearOut" class="btn rounded-xl bg-base-line/60 hover:bg-base-line px-4 py-2 text-base-sub hover:text-base-text transition">Clear</button>
          </div>
        </div>

        <!-- Output -->
        <div class="mt-6">
          <pre id="output" class="rounded-xl bg-black/60 border border-base-line p-4 overflow-auto text-sm leading-relaxed"></pre>
        </div>
      </div>
    </section>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 hidden">
      <div class="rounded-xl bg-white/10 text-base-text px-4 py-2 border border-base-line shadow-soft">
        <span id="toastMsg" class="text-sm"></span>
      </div>
    </div>

    <!-- Safelist classes for Tailwind JIT (used from JS) -->
    <div class="hidden">
      <span class="bg-red-500/10"></span>
      <span class="bg-base-warn/10"></span>
      <span class="text-base-sub"></span>
      <span class="text-base-text"></span>
      <span class="border-base-line"></span>
    </div>
  </div>

  <script>
    // ======= CONFIG =======
    const API = "https://test.mutahirmasood.com/api"; // Directus mount

    // ======= UI UTILS =======
    const $ = (id) => document.getElementById(id);
    function toast(msg) { $("toastMsg").textContent = msg; $("toast").classList.remove("hidden"); setTimeout(()=>$("toast").classList.add("hidden"), 2200); }
    function show(o) { $("output").textContent = typeof o === "string" ? o : JSON.stringify(o, null, 2); }
    function setAuthedUI(isAuthed, meEmail = "") {
      if (isAuthed) {
        $("status").textContent = meEmail ? `Signed in — ${meEmail}` : "Signed in";
        $("loginForm").classList.add("hidden");
        $("actions").classList.remove("hidden");
        $("logout").classList.remove("hidden");
        $("hint").classList.remove("hidden");
      } else {
        $("status").textContent = "Please log in.";
        $("loginForm").classList.remove("hidden");
        $("actions").classList.add("hidden");
        $("logout").classList.add("hidden");
        $("hint").classList.add("hidden");
        setSessionExpiryMs(null);
      }
    }

    // ======= SESSION TIMER =======
    let expiryAtMs = null;
    let tickHandle = null;
    let refreshTimeout = null;

    function clearSchedule() {
      if (tickHandle) { clearInterval(tickHandle); tickHandle = null; }
      if (refreshTimeout) { clearTimeout(refreshTimeout); refreshTimeout = null; }
    }

    function setSessionExpiryMs(msOrNull) {
      expiryAtMs = msOrNull;
      clearSchedule();

      if (!msOrNull) {
        $("sessionTime").textContent = "—";
        $("sessionPill").className = "tick rounded-full border px-3 py-1.5 text-sm border-base-line text-base-sub";
        return;
      }

      startTicking();
      scheduleProactiveRefresh();
    }

    function startTicking() {
      updateCountdown(); // immediate paint
      tickHandle = setInterval(updateCountdown, 1000);
    }

    function updateCountdown() {
      if (!expiryAtMs) return;
      const now = Date.now();
      let diff = Math.max(0, Math.floor((expiryAtMs - now) / 1000)); // seconds

      const mm = String(Math.floor(diff / 60)).padStart(2, "0");
      const ss = String(diff % 60).padStart(2, "0");
      $("sessionTime").textContent = `${mm}:${ss}`;

      // Color states
      const pill = $("sessionPill");
      pill.className = "tick rounded-full border px-3 py-1.5 text-sm";
      if (diff === 0) {
        pill.classList.add("border-base-line","bg-red-500/10","text-base-text");
        clearSchedule();
        return;
      }
      if (diff <= 60) {
        pill.classList.add("border-base-line","bg-red-500/10","text-base-text");
      } else if (diff <= 5 * 60) {
        pill.classList.add("border-base-line","bg-base-warn/10","text-base-text");
      } else {
        pill.classList.add("border-base-line","text-base-sub");
      }
    }

    // ======= AUTH (Docs-aligned) =======
    // Helper: decode JWT 'exp' as a fallback (if needed)
    function decodeJwtExpSeconds(token) {
      try {
        const [, payload] = token.split(".");
        const json = JSON.parse(atob(payload.replace(/-/g, "+").replace(/_/g, "/")));
        if (typeof json?.exp === "number") {
          const nowSec = Math.floor(Date.now() / 1000);
          return Math.max(0, json.exp - nowSec);
        }
      } catch {}
      return null;
    }

    // Sets expiry from a Directus JSON response { data: { expires, expires_at?, access_token? } }
    function setExpiryFromDirectusData(d) {
      let ttlSeconds = null;
      let absMs = null;

      if (typeof d?.expires === "number") ttlSeconds = d.expires;
      if (!ttlSeconds && typeof d?.expires_at === "string") {
        const ts = Date.parse(d.expires_at);
        if (!Number.isNaN(ts)) absMs = ts;
      }
      if (!ttlSeconds && !absMs && typeof d?.access_token === "string") {
        const t = decodeJwtExpSeconds(d.access_token);
        if (t != null) ttlSeconds = t;
      }
      if (ttlSeconds != null) absMs = Date.now() + ttlSeconds * 1000;

      if (absMs) setSessionExpiryMs(absMs);
      return Boolean(absMs);
    }

    async function login(email, password) {
      const r = await fetch(`${API}/auth/login`, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        credentials: "include",
        // Ask for JSON so the response includes { data: { access_token, expires, refresh_token } }
        body: JSON.stringify({ email, password, mode: "json" })
      });
      if (!r.ok) throw new Error(`Login failed: ${r.status}`);
      const { data } = await r.json();
      setExpiryFromDirectusData(data);
      // Align cookies if your app uses cookie auth for subsequent calls
      await refreshSessionCookies();
      return true;
    }

    async function refreshJson() {
      const r = await fetch(`${API}/auth/refresh`, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        credentials: "include",
        body: JSON.stringify({ mode: "json" })
      });
      if (!r.ok) return false;
      const text = await r.text();
      if (!text) return false;
      const { data } = JSON.parse(text);
      setExpiryFromDirectusData(data);
      return true;
    }

    // Optional: re-align cookies after a JSON refresh (for cookie-mode apps)
    async function refreshSessionCookies() {
      await fetch(`${API}/auth/refresh`, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        credentials: "include",
        body: JSON.stringify({ mode: "session" })
      });
    }

    // Proactive refresh ~10s before expiry
    function scheduleProactiveRefresh() {
      const leadMs = 10_000;
      const delay = Math.max(0, expiryAtMs - Date.now() - leadMs);
      refreshTimeout = setTimeout(async () => {
        const ok = await refreshJson();
        if (ok) await refreshSessionCookies();
        scheduleProactiveRefresh();
      }, delay);
    }

    // API fetch with one-time auto refresh on 401
    async function apiFetch(path, init = {}, { retryOn401 = true } = {}) {
      let res = await fetch(`${API}${path}`, { credentials: "include", ...init });
      if (res.status === 401 && retryOn401) {
        const ok = await refreshJson();
        if (ok) {
          await refreshSessionCookies();
          res = await fetch(`${API}${path}`, { credentials: "include", ...init });
        }
      }
      return res;
    }

    async function fetchMe() {
      const r = await apiFetch("/users/me", { method: "GET" }, { retryOn401: false });
      return r.ok ? r.json() : null;
    }

    // ======= INIT: try JSON refresh → cookies → me → timer =======
    (async () => {
      try {
        await refreshJson();              // quietly renew + get TTL
        await refreshSessionCookies();    // ensure cookies match
        const me = await fetchMe();
        if (me?.data) {
          setAuthedUI(true, me.data.email || "");
        } else {
          setAuthedUI(false);
        }
      } catch (e) {
        setAuthedUI(false);
        show(String(e));
      }
    })();

    // ======= EVENTS =======
    // Login
    $("loginForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      $("loginBtn").disabled = true;
      show("Logging in…");

      const email = $("email").value.trim();
      const password = $("password").value;

      try {
        await login(email, password);
        const me = await fetchMe();
        if (me?.data) {
          setAuthedUI(true, me.data.email || "");
          show("Login successful.");
        } else {
          setAuthedUI(false);
          show("Login succeeded but /users/me did not return a user.");
        }
      } catch (err) {
        show(String(err));
      } finally {
        $("loginBtn").disabled = false;
      }
    });

    // Manual refresh
    $("refreshBtn").addEventListener("click", async () => {
      show("Refreshing session…");
      const ok = await refreshJson();
      if (ok) {
        await refreshSessionCookies();
        const me = await fetchMe();
        if (me?.data) setAuthedUI(true, me.data.email || "");
        show("Session refreshed.");
      } else {
        show("No active session to refresh.");
      }
    });

    // Who am I
    $("whoami").addEventListener("click", async () => {
      const res = await apiFetch("/users/me");
      if (!res.ok) return show(`WhoAmI failed: ${res.status}\n${await res.text()}`);
      show(await res.json());
    });

    // Load collection "test"
    $("loadData").addEventListener("click", async () => {
      show("Loading collection…");
      const res = await apiFetch("/items/test");
      if (!res.ok) return show(`Fetch failed: ${res.status}\n${await res.text()}`);
      show(await res.json());
    });

    // Clear output
    $("clearOut").addEventListener("click", () => show(""));

    // Logout
    $("logout").addEventListener("click", async () => {
      const res = await fetch(`${API}/auth/logout`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ mode: "session" })
      });
      if (res.ok) {
        setAuthedUI(false);
        show("Logged out.");
      } else {
        show(`Logout failed: ${res.status}\n${await res.text()}`);
      }
    });
  </script>
</body>
</html>
