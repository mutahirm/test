<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Directus Portal Demo — Realtime (Hardcoded WS)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['ui-sans-serif','system-ui','Inter','Segoe UI','Roboto','Arial'] },
          colors: {
            base: {
              bg: '#0B0F17',
              card: '#111827',
              line: '#1F2937',
              text: '#E5E7EB',
              sub: '#9CA3AF',
              brand: '#60A5FA',
              brand2: '#34D399',
              warn: '#FBBF24',
              danger: '#F87171'
            }
          },
          boxShadow: {
            soft: '0 6px 30px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.03)'
          }
        }
      }
    }
  </script>
  <style>
    .glass { background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); backdrop-filter: blur(10px) saturate(120%); }
    .btn:disabled { opacity:.5; cursor:not-allowed; }
  </style>
</head>

<body class="min-h-screen bg-base-bg text-base-text">
  <div class="max-w-3xl mx-auto px-4 py-10">
    <header class="flex items-center justify-between">
      <h1 class="text-2xl md:text-3xl font-semibold tracking-tight">Directus Portal (Hardcoded WS)</h1>
      <div id="status" class="text-sm text-base-sub">Initializing…</div>
    </header>

    <section class="mt-6 glass rounded-2xl shadow-soft border border-base-line">
      <div class="p-6">
        <form id="loginForm" class="space-y-4">
          <div class="grid md:grid-cols-2 gap-3">
            <input id="email" type="email" autocomplete="username" placeholder="Email"
              class="w-full rounded-xl bg-base-card/60 border border-base-line px-4 py-3" required />
            <input id="password" type="password" autocomplete="current-password" placeholder="Password"
              class="w-full rounded-xl bg-base-card/60 border border-base-line px-4 py-3" required />
          </div>
          <button id="loginBtn" type="submit"
            class="btn rounded-xl bg-base-brand hover:bg-blue-400 text-black font-medium px-5 py-3 transition">
            Login
          </button>
        </form>

        <div class="mt-6">
          <pre id="output" class="rounded-xl bg-black/60 border border-base-line p-4 overflow-auto text-sm leading-relaxed"></pre>
        </div>
      </div>
    </section>
  </div>

  <!-- App -->
  <script type="module">
    /***** CONFIG *****/
    const API_BASE = "https://test.mutahirmasood.com";   // no /api
    const REST_API = "https://test.mutahirmasood.com/api"; // with /api
    const WS_URL   = "wss://test.mutahirmasood.com/api/websocket"; // hardcoded

    /***** Import Directus SDK (ESM build) *****/
    import {
      createDirectus,
      rest,
      realtime,
      authentication
    } from 'https://esm.sh/@directus/sdk@12.1.1';

    const client = createDirectus(API_BASE)
      .with(authentication('cookie'))
      .with(rest())
      .with(realtime({ url: WS_URL })); // hardcoded here

    if (!client.realtime) {
      throw new Error('Realtime plugin not attached — check SDK import');
    }

    /***** Helpers *****/
    const $ = (id) => document.getElementById(id);
    function show(o) { $("output").textContent = typeof o === "string" ? o : JSON.stringify(o, null, 2); }
    function setStatus(msg) { $("status").textContent = msg; }

    async function refreshSession() {
      const r = await fetch(`${REST_API}/auth/refresh`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ mode: "session" })
      });
      return r.ok;
    }

    async function apiFetch(path) {
      return fetch(`${REST_API}${path}`, { credentials: "include" });
    }

    async function fetchMe() {
      const r = await apiFetch("/users/me");
      return r.ok ? r.json() : null;
    }

    async function startRealtime() {
      // subscribe auto-connects with hardcoded WS
      await client.realtime.subscribe("items.test", { event: true }, (payload) => {
        const msg = `[${new Date().toLocaleTimeString()}] ${payload.event.toUpperCase()} → ${JSON.stringify(payload.data)}`;
        const out = $("output");
        out.textContent = msg + "\n" + out.textContent;
      });
      setStatus("Realtime connected (via hardcoded WS)");
    }

    /***** Events *****/
    $("loginForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = $("email").value.trim();
      const password = $("password").value;
      setStatus("Logging in…");

      const res = await fetch(`${REST_API}/auth/login`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ email, password, mode: "session" })
      });

      if (!res.ok) {
        show("Login failed: " + res.status);
        setStatus("Login failed");
        return;
      }

      const me = await fetchMe();
      if (me?.data) {
        setStatus("Signed in as " + me.data.email);
        await startRealtime();
      } else {
        setStatus("Signed in (me lookup failed)");
      }
    });

    // Try restore session on load
    (async () => {
      await refreshSession();
      const me = await fetchMe();
      if (me?.data) {
        setStatus("Restored session: " + me.data.email);
        await startRealtime();
      } else {
        setStatus("Please log in.");
      }
    })();
  </script>
</body>
</html>
