<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Directus — Test Collection (Realtime)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['ui-sans-serif','system-ui','Inter','Segoe UI','Roboto','Arial'] },
          colors: {
            base: {
              bg: '#0B0F17',
              card: '#111827',
              line: '#1F2937',
              text: '#E5E7EB',
              sub: '#9CA3AF',
              brand: '#60A5FA',
              brand2: '#34D399',
              warn: '#FBBF24',
              danger: '#F87171'
            }
          },
          boxShadow: {
            soft: '0 6px 30px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.03)'
          }
        }
      }
    }
  </script>
  <style>
    .glass { background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); backdrop-filter: blur(10px) saturate(120%); }
    .pill { transition: all .2s ease; }
    .mono { font-feature-settings: "calt" 0, "zero" 1; font-variant-numeric: tabular-nums; }
    .btn:disabled { opacity:.5; cursor:not-allowed; }
  </style>
</head>

<body class="min-h-screen bg-base-bg text-base-text font-sans">
  <div class="max-w-6xl mx-auto px-4 py-10">
    <!-- Header -->
    <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div>
        <h1 class="text-2xl md:text-3xl font-semibold tracking-tight">Test Collection — Realtime</h1>
        <p class="text-base-sub text-sm">WebSocket updates via Directus Realtime. Cookie-session auth.</p>
      </div>
      <div class="flex items-center gap-3">
        <span id="connPill" class="pill rounded-full border border-base-line text-base-sub px-3 py-1.5 text-sm">WS: <b id="connState" class="font-medium">—</b></span>
        <span class="pill rounded-full border border-base-line text-base-sub px-3 py-1.5 text-sm">User: <b id="meEmail" class="font-medium">—</b></span>
        <button id="logoutBtn" class="btn hidden rounded-xl px-4 py-2 bg-base-line/50 hover:bg-base-line text-base-sub hover:text-base-text transition">Logout</button>
      </div>
    </header>

    <!-- Controls -->
    <section class="mt-6 glass rounded-2xl shadow-soft border border-base-line">
      <div class="p-4 md:p-6 flex flex-col gap-4">
        <div id="authRow" class="grid md:grid-cols-3 gap-3">
          <input id="email" type="email" autocomplete="username" placeholder="Email"
                 class="rounded-xl bg-base-card/60 border border-base-line px-4 py-3 focus:outline-none focus:ring-2 focus:ring-base-brand/60">
          <input id="password" type="password" autocomplete="current-password" placeholder="Password"
                 class="rounded-xl bg-base-card/60 border border-base-line px-4 py-3 focus:outline-none focus:ring-2 focus:ring-base-brand/60">
          <div class="flex gap-2">
            <button id="loginBtn" class="btn flex-1 rounded-xl bg-base-brand hover:bg-blue-400 text-black font-medium px-5 py-3 transition">Login</button>
            <button id="refreshBtn" class="btn rounded-xl bg-base-line/60 hover:bg-base-line px-4 py-3 text-base-sub hover:text-base-text transition">Refresh</button>
          </div>
        </div>

        <div class="flex flex-wrap items-center gap-2">
          <button id="reloadBtn" class="btn rounded-xl bg-base-brand2/20 hover:bg-base-brand2/30 text-base-text px-4 py-2 transition">Reload Data</button>
          <button id="pauseBtn"  class="btn rounded-xl bg-base-line/60 hover:bg-base-line px-4 py-2 text-base-sub hover:text-base-text transition">Pause Stream</button>
          <button id="clearBtn"  class="btn rounded-xl bg-base-line/60 hover:bg-base-line px-4 py-2 text-base-sub hover:text-base-text transition">Clear Table</button>
          <span class="ml-auto text-sm text-base-sub">events:
            <b id="evtCreate" class="mono">0</b> c /
            <b id="evtUpdate" class="mono">0</b> u /
            <b id="evtDelete" class="mono">0</b> d
          </span>
        </div>

        <div id="status" class="text-xs text-base-sub">Status: Initializing…</div>
      </div>
    </section>

    <!-- Table -->
    <section class="mt-6 glass rounded-2xl shadow-soft border border-base-line">
      <div class="px-4 md:px-6 py-4 overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead id="thead" class="text-left text-base-sub border-b border-base-line">
          </thead>
          <tbody id="tbody" class="divide-y divide-base-line">
          </tbody>
        </table>
        <div id="empty" class="text-base-sub text-sm py-8 text-center hidden">No data yet.</div>
      </div>
    </section>

    <!-- Console -->
    <section class="mt-6">
      <pre id="console" class="rounded-xl bg-black/60 border border-base-line p-4 overflow-auto text-xs leading-relaxed h-56"></pre>
    </section>
  </div>

  <!-- App -->
  <script type="module">
    /***** CONFIG *****/
    const API_BASE = "https://test.mutahirmasood.com";      // no /api
    const REST_API = "https://test.mutahirmasood.com/api";  // with /api

    /***** SDK *****/
    import { createDirectus, authentication, rest, realtime } from "https://cdn.jsdelivr.net/npm/@directus/sdk@latest/dist/index.min.js";

    const client = createDirectus(API_BASE)
      .with(authentication("cookie"))
      .with(rest())
      .with(realtime());

    /***** DOM *****/
    const $ = (id) => document.getElementById(id);
    const consoleEl = $("console");
    const statusEl = $("status");
    const meEmailEl = $("meEmail");
    const connPill = $("connPill");
    const connStateEl = $("connState");
    const thead = $("thead");
    const tbody = $("tbody");
    const empty = $("empty");

    const counters = { create: 0, update: 0, delete: 0 };
    const evtCreate = $("evtCreate");
    const evtUpdate = $("evtUpdate");
    const evtDelete = $("evtDelete");

    /***** UTIL *****/
    function log(line) {
      const ts = new Date().toLocaleTimeString();
      consoleEl.textContent = `[${ts}] ${line}\n` + consoleEl.textContent;
    }
    function setStatus(text) {
      statusEl.textContent = "Status: " + text;
    }
    function setConn(state, tone="neutral") {
      connStateEl.textContent = state;
      connPill.className = "pill rounded-full border px-3 py-1.5 text-sm " + (
        tone === "good" ? "border-emerald-500/40 bg-emerald-500/10 text-emerald-200" :
        tone === "warn" ? "border-yellow-500/40 bg-yellow-500/10 text-yellow-200" :
        tone === "bad"  ? "border-red-500/40 bg-red-500/10 text-red-200" :
                          "border-base-line text-base-sub"
      );
    }
    function bumpCounter(kind) {
      counters[kind]++; evtCreate.textContent = counters.create; evtUpdate.textContent = counters.update; evtDelete.textContent = counters.delete;
    }

    // Data model
    /** Map of id -> item, used for targeted updates */
    const index = new Map();
    /** Current column order */
    let columns = [];

    function deriveColumnsFrom(items) {
      const set = new Set(columns);
      for (const it of items) Object.keys(it || {}).forEach(k => set.add(k));
      // Prefer putting id first if present; keep stable order
      const next = Array.from(set);
      next.sort((a,b) => (a === "id" ? -1 : b === "id" ? 1 : a.localeCompare(b)));
      columns = next;
    }

    function renderHeader() {
      if (!columns.length) { thead.innerHTML = ""; return; }
      thead.innerHTML = `
        <tr>
          ${columns.map(c => `<th class="py-2 pr-6 font-medium">${escapeHtml(c)}</th>`).join("")}
        </tr>`;
    }

    function renderBody() {
      if (index.size === 0) {
        tbody.innerHTML = "";
        empty.classList.remove("hidden");
        return;
      }
      empty.classList.add("hidden");
      // Stable order by id if present, else insertion
      const rows = Array.from(index.values()).sort((a,b) => {
        if (a?.id != null && b?.id != null) return (a.id + "").localeCompare(b.id + "");
        return 0;
      });
      tbody.innerHTML = rows.map(rowHtml).join("");
    }

    function rowHtml(item) {
      return `<tr data-id="${escapeAttr(item?.id)}">
        ${columns.map(c => `<td class="py-2 pr-6 align-top">${formatCell(item?.[c])}</td>`).join("")}
      </tr>`;
    }

    function upsertItem(item) {
      // Merge & store
      const prev = index.get(item.id) || {};
      const merged = { ...prev, ...item };
      index.set(merged.id, merged);

      // If new fields appeared, rebuild columns + rerender all for simplicity
      const beforeCols = columns.slice();
      deriveColumnsFrom([merged]);
      if (columns.length !== beforeCols.length || columns.some((c,i)=>c!==beforeCols[i])) {
        renderHeader(); renderBody(); return;
      }

      // Try targeted replace
      const tr = tbody.querySelector(`tr[data-id="${cssEscape(merged.id)}"]`);
      if (tr) {
        tr.outerHTML = rowHtml(merged);
      } else {
        // Append in correct position by re-rendering (keeps it simple and correct)
        renderBody();
      }
    }

    function deleteItem(id) {
      index.delete(id);
      const tr = tbody.querySelector(`tr[data-id="${cssEscape(id)}"]`);
      if (tr) tr.remove();
      if (index.size === 0) { renderBody(); }
    }

    function clearAll() {
      index.clear(); renderBody();
    }

    function formatCell(v) {
      if (v == null) return `<span class="text-base-sub">—</span>`;
      if (typeof v === "object") return `<code class="text-xs break-all">${escapeHtml(JSON.stringify(v))}</code>`;
      return `<span>${escapeHtml(String(v))}</span>`;
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }
    function escapeAttr(s) { return escapeHtml(s); }
    function cssEscape(s) { return String(s).replace(/"/g, '\\"'); }

    /***** AUTH HELPERS (REST) *****/
    async function refreshSession() {
      const r = await fetch(`${REST_API}/auth/refresh`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ mode: "session" })
      });
      return r.ok;
    }
    async function apiFetch(path, init = {}, { retryOn401 = true } = {}) {
      let res = await fetch(`${REST_API}${path}`, { credentials: "include", ...init });
      if (res.status === 401 && retryOn401) {
        const ok = await refreshSession();
        if (ok) res = await fetch(`${REST_API}${path}`, { credentials: "include", ...init });
      }
      return res;
    }
    async function fetchMe() {
      const r = await apiFetch("/users/me", { method: "GET" }, { retryOn401: false });
      return r.ok ? r.json() : null;
    }

    /***** REALTIME *****/
    let unsub = null;
    let paused = false;

    async function connectRealtime() {
      setConn("connecting…", "warn");
      await client.realtime.connect();
      setConn("connected", "good");
      log("Realtime connected");

      unsub = await client.realtime.subscribe("items.test", { event: true }, (payload) => {
        if (paused) return;
        const { event, data, keys } = payload; // keys has primary key(s) when available
        const id = (data && data.id) || (keys && keys.id);
        if (event === "create") {
          bumpCounter("create");
          upsertItem(data);
          log(`CREATE id=${id}`);
        } else if (event === "update") {
          bumpCounter("update");
          upsertItem(data);
          log(`UPDATE id=${id}`);
        } else if (event === "delete") {
          bumpCounter("delete");
          deleteItem(id);
          log(`DELETE id=${id}`);
        }
      });
    }

    async function disconnectRealtime() {
      if (unsub) { try { await unsub(); } catch(_) {} finally { unsub = null; }
      }
      try { await client.realtime.disconnect(); } catch(_) {}
      setConn("disconnected", "bad");
      log("Realtime disconnected");
    }

    /***** DATA LOAD *****/
    async function loadInitial() {
      setStatus("Loading initial data…");
      const res = await apiFetch("/items/test?limit=-1");
      if (!res.ok) {
        const t = await res.text();
        setStatus(`Initial load failed: ${res.status}`);
        log(t);
        return;
      }
      const json = await res.json();
      const items = Array.isArray(json?.data) ? json.data : [];
      clearAll();
      deriveColumnsFrom(items);
      renderHeader();
      for (const it of items) index.set(it.id, it);
      renderBody();
      setStatus(`Loaded ${items.length} item(s). Listening for changes…`);
    }

    /***** INIT *****/
    async function bootstrap() {
      try {
        await refreshSession();
        const me = await fetchMe();
        if (me?.data) {
          meEmailEl.textContent = me.data.email || "—";
          $("authRow").classList.add("hidden");
          $("logoutBtn").classList.remove("hidden");
          setStatus("Signed in.");
          await loadInitial();
          await connectRealtime();
        } else {
          meEmailEl.textContent = "—";
          $("authRow").classList.remove("hidden");
          $("logoutBtn").classList.add("hidden");
          setStatus("Please log in.");
          setConn("idle");
        }
      } catch (e) {
        setStatus("Init error");
        log(String(e?.message || e));
      }
    }

    await bootstrap();

    /***** EVENTS *****/
    $("loginBtn").addEventListener("click", async () => {
      const email = $("email").value.trim();
      const password = $("password").value;
      if (!email || !password) return;

      $("loginBtn").disabled = true;
      setStatus("Logging in…");
      try {
        const res = await fetch(`${REST_API}/auth/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ email, password, mode: "session" })
        });
        if (!res.ok) {
          setStatus(`Login failed: ${res.status}`);
          log(await res.text());
          return;
        }
        const me = await fetchMe();
        meEmailEl.textContent = me?.data?.email || "—";
        $("authRow").classList.add("hidden");
        $("logoutBtn").classList.remove("hidden");
        setStatus("Signed in.");
        await loadInitial();
        await connectRealtime();
      } finally {
        $("loginBtn").disabled = false;
      }
    });

    $("refreshBtn").addEventListener("click", async () => {
      setStatus("Refreshing session…");
      const ok = await refreshSession();
      if (ok) {
        const me = await fetchMe();
        meEmailEl.textContent = me?.data?.email || "—";
        setStatus("Session refreshed.");
      } else {
        setStatus("No active session.");
      }
    });

    $("logoutBtn").addEventListener("click", async () => {
      setStatus("Logging out…");
      try {
        const r = await fetch(`${REST_API}/auth/logout`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ mode: "session" })
        });
        if (!r.ok) log(await r.text());
      } finally {
        await disconnectRealtime();
        meEmailEl.textContent = "—";
        $("authRow").classList.remove("hidden");
        $("logoutBtn").classList.add("hidden");
        clearAll();
        renderHeader();
        setStatus("Logged out.");
      }
    });

    $("reloadBtn").addEventListener("click", async () => {
      await loadInitial();
    });

    $("pauseBtn").addEventListener("click", async (e) => {
      paused = !paused;
      e.currentTarget.textContent = paused ? "Resume Stream" : "Pause Stream";
      setStatus(paused ? "Stream paused (updates buffered by server, not applied here)" : "Listening for changes…");
    });

    $("clearBtn").addEventListener("click", () => {
      clearAll();
      setStatus("Cleared table (still subscribed).");
    });

  </script>
</body>
</html>
