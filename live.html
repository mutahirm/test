<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Directus Realtime (Session Cookie, WebSocket)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: light dark; }
    body { font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 2rem; }
    .card { max-width: 840px; border: 1px solid #ccc; border-radius: 12px; padding: 16px; }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    input, button { font: inherit; padding: 8px 10px; border-radius: 8px; border: 1px solid #bbb; }
    button.primary { background: #0a7; color: white; border: none; }
    code, pre { background: color-mix(in srgb, CanvasText 10%, Canvas); padding: 2px 6px; border-radius: 6px; }
    #log { white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; max-height: 320px; overflow: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px; }
    .ok { color: #0a7; } .err { color: #c33; }
    .mut { padding: 8px; border-bottom: 1px dashed #ddd; }
  </style>
</head>
<body>
  <h1>Directus Realtime via WebSocket (Session Cookie)</h1>

  <div class="card">
    <p><strong>Config</strong> (pre-filled):</p>
    <ul>
      <li><code>DIRECTUS_URL</code>: <span id="cfg-url"></span></li>
      <li><code>WS_URL</code>: <span id="cfg-ws"></span></li>
      <li><code>COLLECTION</code>: <span id="cfg-col"></span></li>
    </ul>
    <p>Notes:</p>
    <ul>
      <li>If this page is on a different domain than Directus, set cookie flags to <code>SameSite=None; Secure</code> and a shared cookie domain (e.g., <code>.mutahirmasood.com</code>).</li>
      <li>Role permissions still govern what comes through the subscription.</li>
    </ul>
  </div>

  <br />

  <div class="card">
    <h2>1) Login (sets HttpOnly session cookie)</h2>
    <div class="row">
      <input id="email" type="email" placeholder="email@example.com" autocomplete="username" />
      <input id="password" type="password" placeholder="password" autocomplete="current-password" />
      <button id="btn-login" class="primary">Login</button>
      <button id="btn-logout">Logout</button>
      <button id="btn-me">Check /users/me</button>
    </div>
    <p id="auth-status">Status: <em>not checked</em></p>
  </div>

  <br />

  <div class="card">
    <h2>2) Subscribe (WebSocket)</h2>
    <div class="row">
      <button id="btn-connect" class="primary">Connect & Subscribe</button>
      <button id="btn-disconnect">Disconnect</button>
    </div>

    <!-- Kept for reference; ignored in WS mode -->
    <p style="margin-top:12px"><em>Note:</em> GraphQL textarea is ignored in WebSocket mode.</p>
    <textarea id="gql" rows="6" style="width:100%; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;" disabled>
(subscription UI placeholder — not used with /websocket)
    </textarea>

    <div class="row" style="margin-top:8px;">
      <label for="eventFilter">Event filter:</label>
      <select id="eventFilter">
        <option value="">(all)</option>
        <option value="create">create</option>
        <option value="update">update</option>
        <option value="delete">delete</option>
      </select>
    </div>
  </div>

  <br />

  <div class="card">
    <h2>Events</h2>
    <div id="events"></div>
  </div>

  <br />

  <div class="card">
    <h2>Log</h2>
    <div id="log"></div>
  </div>

  <script>
    // ======== CONFIG (pre-filled) ========
    const DIRECTUS_URL = "https://test.mutahirmasood.com/api";      // REST base (login/users)
    const WS_URL       = "wss://test.mutahirmasood.com/api/websocket"; // HARD-CODED WS endpoint
    const COLLECTION   = "test";
    // =====================================

    // Basic helpers
    const $$ = (sel) => document.querySelector(sel);
    const log = (msg, cls="") => {
      const el = document.createElement("div");
      el.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
      if (cls) el.className = cls;
      $$("#log").prepend(el);
    };
    const showStatus = (ok, text) => {
      $$("#auth-status").innerHTML = ok
        ? `<span class="ok">✅ ${text}</span>` : `<span class="err">⛔ ${text}</span>`;
    };

    // Initial UI wiring
    $$("#cfg-url").textContent = DIRECTUS_URL;
    $$("#cfg-ws").textContent = WS_URL;
    $$("#cfg-col").textContent = COLLECTION;

    // --- Auth flows (session cookie) ---
    async function login(email, password) {
      const res = await fetch(`${DIRECTUS_URL}/auth/login`, {
        method: "POST",
        credentials: "include",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, password })
      });
      if (!res.ok) {
        const err = await safeJson(res);
        throw new Error(`Login failed: ${res.status} ${res.statusText} ${err?.errors?.[0]?.message || ""}`);
      }
      log("Logged in; session cookie should be set.", "ok");
      return res.json().catch(() => ({}));
    }

    async function logout() {
      await fetch(`${DIRECTUS_URL}/auth/logout`, { method: "POST", credentials: "include" });
      log("Logged out (session cleared).", "ok");
    }

    async function usersMe() {
      const res = await fetch(`${DIRECTUS_URL}/users/me`, { credentials: "include" });
      if (!res.ok) {
        showStatus(false, "Not authenticated");
        throw new Error(`users/me: ${res.status} ${res.statusText}`);
      }
      const me = await res.json();
      showStatus(true, `Authenticated as ${me?.data?.email || me?.data?.id || "unknown user"}`);
      log("users/me succeeded.", "ok");
      return me;
    }

    async function safeJson(res) {
      try { return await res.json(); } catch { return null; }
    }

    // --- Directus Realtime over WebSocket (/websocket) ---
    let socket, connected = false, uid = null;

    function connectAndSubscribe() {
      if (connected) { log("Already connected."); return; }

      log("Opening WebSocket to " + WS_URL);
      socket = new WebSocket(WS_URL); // no subprotocol for Directus WS

      socket.onopen = () => {
        connected = true;
        uid = crypto.randomUUID();
        log("WS open. Subscribing…");

        // Build subscription payload
        const event = $$("#eventFilter").value || undefined; // create | update | delete | undefined
        const payload = {
          type: "subscribe",
          collection: COLLECTION,
          uid,
          ...(event ? { event } : {}),
          // Optional: request specific fields
          // query: { fields: ["id", "title", "status", "date_created"] }
        };

        socket.send(JSON.stringify(payload));
      };

      socket.onmessage = (ev) => {
        let msg;
        try { msg = JSON.parse(ev.data); } catch { return; }

        // Handle pings from server
        if (msg?.type === "ping") {
          try { socket.send(JSON.stringify({ type: "pong" })); } catch {}
          return;
        }

        // Subscription initialized
        if (msg?.type === "subscription" && msg?.event === "init") {
          log(`Subscription acknowledged (uid=${uid}).`, "ok");
          return;
        }

        // Subscription events: create/update/delete
        if (msg?.type === "subscription" && ["create","update","delete"].includes(msg?.event)) {
          onSubscriptionEvent(msg);
          return;
        }

        // Any other messages (errors, etc)
        if (msg?.type === "error") {
          log(`WS error: ${JSON.stringify(msg)}`, "err");
          return;
        }
      };

      socket.onerror = () => log("WS error (see console).", "err");

      socket.onclose = () => {
        connected = false;
        log("WS closed.");
      };
    }

    function onSubscriptionEvent(msg) {
      const wrap = document.createElement("div");
      wrap.className = "mut";

      // data may be array (create/update) or id-only for delete
      const dataPretty = syntaxHighlight(msg?.data ?? msg?.key ?? msg ?? null);
      wrap.innerHTML = `
        <div><strong>event:</strong> ${msg?.event}</div>
        <div><strong>uid:</strong> ${msg?.uid || uid || "-"}</div>
        <div><strong>data:</strong> <pre>${dataPretty}</pre></div>
      `;
      $$("#events").prepend(wrap);
    }

    function syntaxHighlight(obj) {
      const json = JSON.stringify(obj, null, 2);
      return json
        .replace(/(&|<|>)/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[s]))
        .replace(/"(.*?)":/g, '<span style="color:#6a5acd">"$1"</span>:')
        .replace(/\b(true|false|null)\b/g, '<span style="color:#c33">$1</span>')
        .replace(/\b(\d+)\b/g, '<span style="color:#0a7">$1</span>');
    }

    function disconnect() {
      if (!socket) return;
      try {
        // Try to unsubscribe this connection before closing
        if (uid && socket.readyState === WebSocket.OPEN) {
          socket.send(JSON.stringify({ type: "unsubscribe", uid }));
        }
      } catch {}
      try { socket.close(1000, "client close"); } catch {}
      socket = null;
      connected = false;
      log("Disconnected.");
    }

    // --- UI bindings ---
    $$("#btn-login").addEventListener("click", async () => {
      try {
        const email = $$("#email").value.trim();
        const password = $$("#password").value;
        if (!email || !password) { alert("Enter email and password."); return; }
        await login(email, password);
        await usersMe();
      } catch (e) {
        showStatus(false, "Login failed");
        log(String(e), "err");
      }
    });

    $$("#btn-logout").addEventListener("click", async () => {
      try { await logout(); showStatus(false, "Logged out"); } catch (e) { log(String(e), "err"); }
    });

    $$("#btn-me").addEventListener("click", async () => {
      try { await usersMe(); } catch (e) { log(String(e), "err"); }
    });

    $$("#btn-connect").addEventListener("click", () => {
      connectAndSubscribe();
    });

    $$("#btn-disconnect").addEventListener("click", () => {
      disconnect();
    });
  </script>
</body>
</html>
